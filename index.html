<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TMA/WGMMA Async Pipeline</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0d1117;
      color: #e6edf3;
      padding: 40px;
      margin: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    h1 {
      color: #58a6ff;
      font-size: 20px;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #8b949e;
      font-size: 14px;
      margin-bottom: 30px;
    }

    .controls {
      margin-bottom: 20px;
    }

    button {
      background: #238636;
      color: #fff;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }

    button:hover {
      background: #2ea043;
    }

    .step-label {
      color: #58a6ff;
      font-size: 14px;
      display: inline-block;
      margin-left: 15px;
    }

    /* Gantt Chart */
    .gantt {
      background: #161b22;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .gantt-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .gantt-label {
      width: 120px;
      font-size: 13px;
      color: #8b949e;
      flex-shrink: 0;
    }

    .gantt-label.buf0 {
      color: #f0883e;
    }

    .gantt-label.buf1 {
      color: #3fb950;
    }

    .gantt-track {
      flex: 1;
      height: 28px;
      background: #21262d;
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }

    .gantt-bar {
      position: absolute;
      top: 3px;
      bottom: 3px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .bar-load {
      background: #f0883e;
      color: #000;
    }

    .bar-compute {
      background: #3fb950;
      color: #000;
    }

    .bar-store {
      background: #a371f7;
      color: #fff;
    }

    /* Time markers */
    .time-axis {
      display: flex;
      margin-left: 120px;
      margin-bottom: 10px;
    }

    .time-tick {
      flex: 1;
      text-align: center;
      font-size: 11px;
      color: #484f58;
    }

    /* Info box */
    .info {
      background: #161b22;
      border-radius: 8px;
      padding: 16px 20px;
      font-size: 14px;
      line-height: 1.6;
      border-left: 3px solid #58a6ff;
    }

    .info code {
      background: #21262d;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
      color: #f0883e;
    }

    .parallel-tag {
      background: #238636;
      color: #fff;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    /* Legend */
    .legend {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-box {
      width: 14px;
      height: 14px;
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>TMA/WGMMA Async Pipeline — Double Buffering</h1>
    <p class="subtitle">Issue is instant. Execution is async. Multiple ops run in parallel on different hardware.</p>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-box" style="background:#f0883e"></div>
        <span>Load (TMA)</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background:#3fb950"></div>
        <span>Compute (WGMMA)</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background:#a371f7"></div>
        <span>Store (TMA)</span>
      </div>
    </div>

    <div class="controls">
      <button onclick="prev()">← Prev</button>
      <button onclick="next()">Next →</button>
      <button onclick="toggleAuto()" id="autoBtn">▶ Auto</button>
      <span class="step-label">Step <span id="stepNum">0</span> / 8</span>
    </div>

    <div class="gantt">
      <div class="time-axis">
        <div class="time-tick">T0</div>
        <div class="time-tick">T1</div>
        <div class="time-tick">T2</div>
        <div class="time-tick">T3</div>
        <div class="time-tick">T4</div>
        <div class="time-tick">T5</div>
        <div class="time-tick">T6</div>
        <div class="time-tick">T7</div>
        <div class="time-tick">T8</div>
        <div class="time-tick">T9</div>
        <div class="time-tick">T10</div>
        <div class="time-tick">T11</div>
      </div>

      <div class="gantt-row">
        <div class="gantt-label buf0">Buf0 Load</div>
        <div class="gantt-track" id="track-b0l"></div>
      </div>
      <div class="gantt-row">
        <div class="gantt-label buf0">Buf0 Compute</div>
        <div class="gantt-track" id="track-b0c"></div>
      </div>
      <div class="gantt-row">
        <div class="gantt-label buf0">Buf0 Store</div>
        <div class="gantt-track" id="track-b0s"></div>
      </div>
      <div class="gantt-row">
        <div class="gantt-label buf1">Buf1 Load</div>
        <div class="gantt-track" id="track-b1l"></div>
      </div>
      <div class="gantt-row">
        <div class="gantt-label buf1">Buf1 Compute</div>
        <div class="gantt-track" id="track-b1c"></div>
      </div>
      <div class="gantt-row">
        <div class="gantt-label buf1">Buf1 Store</div>
        <div class="gantt-track" id="track-b1s"></div>
      </div>
    </div>

    <div class="info" id="info"></div>
  </div>

  <script>
    const TOTAL_TIME = 12;

    const steps = [
      {
        bars: [
          {track: 'b0l', start: 0, end: 2, type: 'load'},
          {track: 'b1l', start: 0, end: 2, type: 'load'},
        ],
        info: `<strong>T0:</strong> Issue <code>cp.async(buf0)</code> and <code>cp.async(buf1)</code> back-to-back.<br>Both loads start <strong>simultaneously</strong> on TMA unit.`
      },
      {
        bars: [
          {track: 'b0l', start: 0, end: 2, type: 'load'},
          {track: 'b1l', start: 0, end: 2, type: 'load'},
        ],
        info: `<strong>T0-T2:</strong> Both loads executing in parallel. Thread waits on mbarrier for buf0.`
      },
      {
        bars: [
          {track: 'b0l', start: 0, end: 2, type: 'load'},
          {track: 'b1l', start: 0, end: 2, type: 'load'},
          {track: 'b0c', start: 2, end: 5, type: 'compute'},
        ],
        info: `<strong>T2:</strong> Loads complete. Issue <code>wgmma(buf0)</code>. Tensor cores start computing.`
      },
      {
        bars: [
          {track: 'b0l', start: 0, end: 2, type: 'load'},
          {track: 'b1l', start: 0, end: 2, type: 'load'},
          {track: 'b0c', start: 2, end: 5, type: 'compute'},
        ],
        info: `<strong>T2-T5:</strong> WGMMA executing on tensor cores. Buf1 data ready, waiting.`
      },
      {
        bars: [
          {track: 'b0l', start: 0, end: 2, type: 'load'},
          {track: 'b1l', start: 0, end: 2, type: 'load'},
          {track: 'b0c', start: 2, end: 5, type: 'compute'},
          {track: 'b0s', start: 5, end: 7, type: 'store'},
          {track: 'b1c', start: 5, end: 8, type: 'compute'},
        ],
        info: `<strong>T5:</strong> Buf0 compute done. Issue <code>tma_store(buf0)</code> + <code>wgmma(buf1)</code>.<br><span class="parallel-tag">PARALLEL</span> Store Buf0 on TMA ∥ Compute Buf1 on Tensor Cores`
      },
      {
        bars: [
          {track: 'b0l', start: 0, end: 2, type: 'load'},
          {track: 'b1l', start: 0, end: 2, type: 'load'},
          {track: 'b0c', start: 2, end: 5, type: 'compute'},
          {track: 'b0s', start: 5, end: 7, type: 'store'},
          {track: 'b1c', start: 5, end: 8, type: 'compute'},
          {track: 'b0l', start: 7, end: 9, type: 'load'},
        ],
        info: `<strong>T7:</strong> Store Buf0 done. Issue <code>cp.async(buf0)</code> to reload.<br><span class="parallel-tag">PARALLEL</span> Load Buf0 ∥ Compute Buf1 still running`
      },
      {
        bars: [
          {track: 'b0l', start: 0, end: 2, type: 'load'},
          {track: 'b1l', start: 0, end: 2, type: 'load'},
          {track: 'b0c', start: 2, end: 5, type: 'compute'},
          {track: 'b0s', start: 5, end: 7, type: 'store'},
          {track: 'b1c', start: 5, end: 8, type: 'compute'},
          {track: 'b0l', start: 7, end: 9, type: 'load'},
          {track: 'b1s', start: 8, end: 10, type: 'store'},
        ],
        info: `<strong>T8:</strong> Buf1 compute done. Issue <code>tma_store(buf1)</code>.<br><span class="parallel-tag">PARALLEL</span> Store Buf1 ∥ Load Buf0 still running`
      },
      {
        bars: [
          {track: 'b0l', start: 0, end: 2, type: 'load'},
          {track: 'b1l', start: 0, end: 2, type: 'load'},
          {track: 'b0c', start: 2, end: 5, type: 'compute'},
          {track: 'b0s', start: 5, end: 7, type: 'store'},
          {track: 'b1c', start: 5, end: 8, type: 'compute'},
          {track: 'b0l', start: 7, end: 9, type: 'load'},
          {track: 'b1s', start: 8, end: 10, type: 'store'},
          {track: 'b0c', start: 9, end: 12, type: 'compute'},
          {track: 'b1l', start: 10, end: 12, type: 'load'},
        ],
        info: `<strong>T9-10:</strong> Buf0 load done → <code>wgmma(buf0)</code>. Buf1 store done → <code>cp.async(buf1)</code>.<br><span class="parallel-tag">PARALLEL</span> Compute Buf0 ∥ Load Buf1 — <strong>cycle repeats!</strong>`
      },
    ];

    let current = 0;
    let autoInterval = null;

    function render() {
      document.getElementById('stepNum').textContent = current;

      // Clear all tracks
      ['b0l', 'b0c', 'b0s', 'b1l', 'b1c', 'b1s'].forEach(id => {
        document.getElementById('track-' + id).innerHTML = '';
      });

      // Draw bars
      const step = steps[current];
      step.bars.forEach(bar => {
        const track = document.getElementById('track-' + bar.track);
        const div = document.createElement('div');
        div.className = 'gantt-bar bar-' + bar.type;
        div.style.left = (bar.start / TOTAL_TIME * 100) + '%';
        div.style.width = ((bar.end - bar.start) / TOTAL_TIME * 100) + '%';
        track.appendChild(div);
      });

      document.getElementById('info').innerHTML = step.info;
    }

    function next() {
      current = (current + 1) % steps.length;
      render();
    }

    function prev() {
      current = (current - 1 + steps.length) % steps.length;
      render();
    }

    function toggleAuto() {
      const btn = document.getElementById('autoBtn');
      if (autoInterval) {
        clearInterval(autoInterval);
        autoInterval = null;
        btn.textContent = '▶ Auto';
      } else {
        autoInterval = setInterval(next, 1500);
        btn.textContent = '⏸ Stop';
      }
    }

    render();
  </script>
</body>

</html>
