<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>m-barrier Producer-Consumer Pipeline</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 20px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 {
      color: #76c7ff;
      font-size: 22px;
      margin-bottom: 30px;
      text-align: center;
    }

    .pipeline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 30px;
      margin: 40px 0;
    }

    .actor {
      background: #1a1a2e;
      border-radius: 8px;
      padding: 20px;
      width: 180px;
      text-align: center;
    }

    .producer {
      border: 2px solid #ffd166;
    }

    .consumer {
      border: 2px solid #06d6a0;
    }

    .producer h2 {
      color: #ffd166;
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .consumer h2 {
      color: #06d6a0;
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .status {
      font-size: 14px;
      min-height: 40px;
      line-height: 1.4;
    }

    .buffer-container {
      display: flex;
      gap: 25px;
      justify-content: center;
      flex: 1;
    }

    .buffer {
      background: #16213e;
      border: 2px solid #4a5568;
      border-radius: 8px;
      padding: 15px;
      width: 170px;
      transition: all 0.3s ease;
    }

    .buffer h3 {
      margin: 0 0 15px 0;
      color: #ffd166;
      font-size: 14px;
      text-align: center;
    }

    .barrier {
      font-size: 12px;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .barrier.idle {
      background: #2d3748;
      color: #a0aec0;
    }

    .barrier.waiting {
      background: #ef476f;
      color: #fff;
      font-weight: 600;
      animation: blink 1s infinite;
    }

    .barrier.signaled {
      background: #06d6a0;
      color: #000;
      font-weight: 600;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .buffer.loading {
      border-color: #ffd166;
      box-shadow: 0 0 15px rgba(255, 209, 102, 0.3);
    }

    .buffer.computing {
      border-color: #06d6a0;
      box-shadow: 0 0 15px rgba(6, 214, 160, 0.3);
    }

    .buffer.ready {
      border-color: #76c7ff;
      background: rgba(118, 199, 255, 0.1);
    }

    .controls {
      text-align: center;
      margin: 30px 0;
    }

    button {
      background: #9f7aea;
      color: #fff;
      border: none;
      padding: 12px 30px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background: #8b5cf6;
    }

    .step-info {
      margin-top: 20px;
      padding: 20px;
      background: #1a1a2e;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
    }

    .step-info strong {
      color: #76c7ff;
    }

    .step-info ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .step-info li {
      margin: 5px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>TMA/WGMMA m-barrier Pipeline (QSIZE=2)</h1>

    <div class="controls">
      <button onclick="nextStep()">Next Step →</button>
      <span style="margin-left: 20px; color: #76c7ff;">Step: <span id="stepNum">0</span></span>
    </div>

    <div class="pipeline">
      <div class="actor producer">
        <h2>Producer (TMA)</h2>
        <div class="status" id="prodStatus">Idle</div>
      </div>

      <div class="arrow">→</div>

      <div class="buffer-container">
        <div class="buffer" id="buf0">
          <h3>Buffer 0</h3>
          <div class="barrier idle" id="load0">Load: Idle</div>
          <div class="barrier idle" id="store0">Store: Idle</div>
        </div>
        <div class="buffer" id="buf1">
          <h3>Buffer 1</h3>
          <div class="barrier idle" id="load1">Load: Idle</div>
          <div class="barrier idle" id="store1">Store: Idle</div>
        </div>
      </div>

      <div class="arrow">→</div>

      <div class="actor consumer">
        <h2>Consumer (WGMMA)</h2>
        <div class="status" id="consStatus">Idle</div>
      </div>
    </div>

    <div class="step-info" id="stepInfo"></div>
  </div>

  <script>
    const steps = [
      {
        step: 0, prod: "Idle", cons: "Idle",
        info: "Both buffers empty. Producer and consumer idle.",
        buf0: {class: "", load: "Idle", store: "Idle"},
        buf1: {class: "", load: "Idle", store: "Idle"}
      },
      {
        step: 1, prod: "TMA Load → Buffer 0", cons: "Waiting on Load Barrier 0",
        info: "<strong>Producer:</strong> Issues async TMA transfer to fill Buffer 0.<br><strong>Consumer:</strong> Stalled on Load Barrier 0 (waiting for data).",
        buf0: {class: "loading", load: "Waiting", store: "Idle"},
        buf1: {class: "", load: "Idle", store: "Idle"}
      },
      {
        step: 2, prod: "TMA Load → Buffer 1", cons: "WGMMA on Buffer 0",
        info: "<strong>Load Barrier 0 → Signaled</strong>: Data ready.<br><strong>Consumer:</strong> Unblocks and starts compute on Buffer 0.<br><strong>Producer:</strong> Immediately starts loading Buffer 1 (overlap).",
        buf0: {class: "computing", load: "Signaled", store: "Waiting"},
        buf1: {class: "loading", load: "Waiting", store: "Idle"}
      },
      {
        step: 3, prod: "Waiting on Store Barrier 0", cons: "WGMMA on Buffer 1",
        info: "<strong>Consumer:</strong> Finished Buffer 0 → <strong>Store Barrier 0 → Signaled</strong>. Now computing on Buffer 1.<br><strong>Producer:</strong> Sees Store Barrier 0 signaled → can safely reload Buffer 0.",
        buf0: {class: "ready", load: "Signaled", store: "Signaled"},  // FIXED: Not computing, store barrier signaled
        buf1: {class: "computing", load: "Signaled", store: "Waiting"}  // FIXED: This is the active compute buffer
      },
      {
        step: 4, prod: "TMA Load → Buffer 0", cons: "Waiting on Load Barrier 1",
        info: "<strong>Producer:</strong> Reloads Buffer 0 while consumer computes on Buffer 1.<br><strong>Load Barrier 1 → Signaled</strong>: Consumer unblocks and starts Buffer 1 compute.",
        buf0: {class: "loading", load: "Waiting", store: "Signaled"},
        buf1: {class: "ready", load: "Signaled", store: "Waiting"}
      },
      {
        step: 5, prod: "TMA Load → Buffer 1", cons: "WGMMA on Buffer 0",
        info: "<strong>Pipeline Steady State:</strong> Continuous ping-pong. Barriers alternate between waiting (stall) and signaled (ready) every cycle.",
        buf0: {class: "computing", load: "Signaled", store: "Waiting"},
        buf1: {class: "loading", load: "Waiting", store: "Signaled"}
      }
    ];

    let currentStep = 0;

    function updateDisplay() {
      const s = steps[currentStep];
      document.getElementById('stepNum').textContent = s.step;
      document.getElementById('prodStatus').textContent = s.prod;
      document.getElementById('consStatus').textContent = s.cons;
      document.getElementById('stepInfo').innerHTML = s.info;

      ['buf0', 'buf1'].forEach((bufId, idx) => {
        const buf = document.getElementById(bufId);
        const config = s[bufId];
        buf.className = 'buffer ' + config.class;

        const loadBar = document.getElementById('load' + idx);
        loadBar.textContent = `Load: ${config.load}`;
        loadBar.className = 'barrier ' + config.load.toLowerCase();

        const storeBar = document.getElementById('store' + idx);
        storeBar.textContent = `Store: ${config.store}`;
        storeBar.className = 'barrier ' + config.store.toLowerCase();
      });
    }

    function nextStep() {
      currentStep = (currentStep + 1) % steps.length;
      updateDisplay();
    }

    updateDisplay();
  </script>
</body>

</html>
